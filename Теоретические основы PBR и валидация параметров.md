# **Теоретические основы PBR-рендеринга и допустимые диапазоны значений (анализ теоретических основ PBR-рендеринга и определение допустимых диапазонов)**

## **1\. Эволюция Physically Based Rendering (PBR)**

Physically Based Rendering — это математическая модель, целью которой является воспроизведение поведения света в соответствии с законами термодинамики и оптики. В индустрии стандартом де\-факто считается «Модель Disney», представленная Брентом Берли на SIGGRAPH 2012. Она объединила сложную физику с интуитивно понятными параметрами, позволив отделить свойства материала от условий освещения. Это гарантирует, что объект будет выглядеть корректно в любой сцене.

## **2\. Физические принципы и математическая модель**

### **Модель микрограней и функция BRDF**

В основе PBR лежит теория микрограней (**Microfacet Theory**). С точки зрения физики, ни одна поверхность (кроме зеркала) не является идеально гладкой. Она состоит из мириад крошечных микроскопических граней.

Для описания этого процесса используется функция **BRDF** (Bidirectional Reflective Distribution Function). Современный стандарт в Unreal Engine — это модель **Cook-Torrance**, которая описывает зеркальное отражение через три компонента:

1. **D (Distribution function): Распределение микрограней. Используется алгоритм Trowbridge-Reitz GGX, который лучше других имитирует «длинные хвосты» бликов реальных поверхностей. 
2. **G (Geometric shadowing/masking): Учитывает самозатенение микрограней.
3. **F (Fresnel): Уравнение Френеля. Описывает, как отражательная способность растет при взгляде под острым углом.

## **Основные карты PBR и их валидация:**
**Для анализа использовались эталонные значения из документации Epic Games и докладов Sebastien Lagarde. Все значения яркости для материалов основаны на фотометрических измерениях реальных поверхностей.**

### **Карта Albedo (Base Color)**
Так же называют Base Color или Diffuse.
Обозначает отражательную способность поверхности (от лат. albus - белый).
Эта карта несёт в себе информацию о цвете диффузного рассеивания (цвет материала при рассеянном освещении)(для диэлектриков) или цвете зеркального отражения (для металлов).

* **Минимальный порог (30-50 sRGB):** Соответствует свежему асфальту или древесному углю. Отражательная способность (Albedo) ниже 0.02 (2%) физически невозможна для твердых тел. Если художник использует 0 sRGB, поверхность поглощает 100% фотонов, что нарушает закон сохранения энергии и делает невозможным расчет вторичных отражений (GI).  
* **Максимальный порог (240-243 sRGB):** Соответствует чистому снегу или оксиду магния. Альбедо выше 0.9 (90%) приводит к тому, что свет бесконечно отражается между поверхностями.

### **Карта Normal Map**
Используется для иммитации сложного рельефа путём изменения нормали пикселя без добавления полигонов.
Это цветная карта в которой обозначается направления вектора для каждого пикселя. На основе вектора нормали движок понимает под каким углом должен падать свет на каждый конкретный пиксель в материале.

### **Карта Roughness/Glossiness**
Чёрно-белая карта, определяющая насколько материал является матовым (шершавым) или глняцевым (зеркальным).

* Roughness: 0 - матовый, 1 - глянцевый.
* Glossiness (инвертированный Roughness): 1 - глянцевый, 0 - матовый.

* В реальном мире Roughness почти никогда не бывает 0.0 (даже идеально гладкие поверхности имеют микродефекты).
Рекомендуемый минимальный порог (0.02 - 0.05)

### **Карта Metalic**
Чёрно-белая карта, определяющая тип проводимости материала (диэектрики и металлы).

* Карта должна быть бинарной (0 или 1). Промежуточные значения допустимы лишь на стыках материалов или для иммитации окисления/грязи/пыли. Если объект на 50% металлический по всей площади - это физическая ошибка.
* Исключительно для Unreal Engine принято не делать Matallic равным 1, т.к. это плохо выглядит на финальной картике. Для более красивого отображения металлов принято не заходить выше значений 0.9-0.94

### **Карта Specular**
Обычно цветная карта (есть исключения с чёрно-белым вариантом), определяет зеркальное отражение металлов (цвет металла) и коэффициент отражения диэлектриков.

* Для диэлектриков используется только серые оттентки (за исключением редких материалов или художественной необходимости).
* Минимальные порог (40-63) соответстсвует для **диэелектриков**.
* Максимальный порог (185-235) соответствует для **металлов**.
* Значения между (63-185) являются переходными значениям и используется только при необходимости.

### **Карта Ambient Oclussion**
Чёрно-белая карта, опысывающая затения в углублениях, куда не попадает фоновое освещение.

### **Остальные карты:**
Так же существует множетсво других параметров и карт, но они используются в основном при создании основных карт и в движке используются только в редких случаях.

## **3\. Сравнение систем: Standard Shading и Substrate**

### **Рабочий процесс Metallic/Roughness**
Стандартная модель Unreal Engine предпологает, что материал - это один монолитный слой.

* Поскольку Metallic является чёрно-белой картой, то цвет зеркальных отражений (цвет металла) берётся из карты albedo (или же base color).

### **Рабочий процесс (Specular/Glossiness)**

Данный рабочй процесс не используется в Unreal Engine.

* Карта Specular здесь цветная, а значит, что цвет зеркальных отражений теперь берётся не из albedo (base color), а из specular.
* Карта Glossiness - это инвертированная карта Roughness. То есть тут наоборот 0 - матовая, а 1 - глянцевая поверхность.

### **Unreal Engine Substrate (Framework нового поколения)**
**Sustrate** - это переход от параметров к структуре. Теперь материал - это набор слоёв (Slabs), которые взаимодействуют друг с другом.
К примеру, Substrate автоматически высчитывает, сколько света поглотил верхний слой (лак) и сколько дошло до нижнего (металл), обеспечивая физически корректное распространение света в материале. В старой моделе однослойного материала это поведение света бы иммитировалось или вообще не учитывалось.

* В Substrate используется рабочий процесс Specular/Roughness. Используется комплексный показатель преломления IOR (Index Of Reflection) и отражения под углами 0 (F0) и 90 (F90) градусов. Это позволяет имитировать цветные блики на диэлектриках и сложные интерференционные эффекты.



