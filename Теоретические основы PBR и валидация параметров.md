# **Глава: Теоретические основы PBR-рендеринга и допустимые диапазоны значений**

## **1\. Эволюция Physically Based Rendering (PBR)**

Physically Based Rendering — это математическая модель, целью которой является воспроизведение поведения света в соответствии с законами термодинамики и оптики. В индустрии стандартом де\-факто считается «Модель Disney», представленная Брентом Берли на SIGGRAPH 2012, которая объединила сложную физику с интуитивно понятными параметрами для художников.

### **Почему это важно (GDC Context)**

В эпоху до PBR художники «подкручивали» яркость текстур под конкретное освещение сцены. В PBR освещение и материалы разделены. Это гарантирует, что объект, настроенный один раз, будет выглядеть корректно и в яркий полдень, и в лунную ночь.

## **2\. Физические принципы и математическая модель**

### **Модель микрограней и функция BRDF**

В основе PBR лежит теория микрограней (**Microfacet Theory**). С точки зрения физики, ни одна поверхность (кроме зеркала) не является идеально гладкой. Она состоит из мириад крошечных микроскопических граней.

Для описания этого процесса используется функция **BRDF** (Bidirectional Reflective Distribution Function). Современный стандарт в Unreal Engine — это модель **Cook-Torrance**, которая состоит из трех компонентов:

1. **D (Distribution function):** Распределение микрограней (насколько они параллельны друг другу). Используется алгоритм **Trowbridge-Reitz GGX**.  
2. **G (Geometric shadowing/masking):** Учитывает, как микрограни заслоняют друг друга.  
3. **F (Fresnel):** Уравнение Френеля, определяющее процент отраженного света в зависимости от угла обзора.

### **Происхождение лимитов sRGB (Albedo)**

Значения яркости для материалов не берутся «из головы». Они основаны на фотометрических измерениях реальных поверхностей.

* **Минимальный порог (30-50 sRGB):** Соответствует свежему асфальту или древесному углю. Отражательная способность (Albedo) ниже 0.02 (2%) физически невозможна для твердых тел (кроме Vantablack). Если художник использует 0 sRGB, поверхность поглощает 100% фотонов, что нарушает закон сохранения энергии и делает невозможным расчет вторичных отражений (GI).  
* **Максимальный порог (240-243 sRGB):** Соответствует чистому снегу или оксиду магния. Альбедо выше 0.9 (90%) приводит к тому, что свет бесконечно отражается между поверхностями, «выжигая» картинку.

## **3\. Сравнение систем: Standard Shading vs Substrate**

### **Традиционный рабочий процесс (Metallic/Roughness)**

В стандартном материале UE (Lambert для диффуза \+ GGX для блика) мы разделяем мир на проводники и диэлектрики.

* **Metallic:** Переключает модель. При Metallic \= 1 диффузный цвет обнуляется, а Base Color становится цветом зеркального отражения (F0).  
* **Roughness:** Управляет «рассыпанием» функции GGX.

### **Unreal Engine Substrate (Framework нового поколения)**

**Substrate** — это замена классической модели «одного слоя». В реальности материалы часто многослойны (например, краска на металле под слоем лака).

| Параметр | Standard PBR | Substrate |
| :---- | :---- | :---- |
| **Логика** | Плоская модель, один слой | Граф слоев (Slabs), физическое смешивание |
| **Specular** | Скаляр (0.5 по умолчанию) | Заменяется на F0/F90 или IOR (Index of Refraction) |
| **Многослойность** | Невозможна без костылей (Clear Coat) | Нативная (например, слой пыли поверх слоя золота) |

В Substrate вместо переключателя Metallic используется более точное описание через **диэлектрический IOR** или **комплексный IOR для металлов**. Это позволяет визуальному анализатору проверять корректность не просто «текстуры», а «энергетического веса» всего пирога слоев.

## **4\. Допустимые диапазоны и валидация**

Для разработки модуля анализа мы используем эталонные значения из документации Epic Games и докладов Sebastien Lagarde:

### **4.1. Base Color**

* **Диэлектрики:** Диапазон \[0.017, 0.81\] в линейном пространстве, что в sRGB \~ **\[40, 230\]**.  
* **Металлы:** Диапазон \[0.6, 1.0\] в линейном пространстве, sRGB \~ **\[180, 255\]**.

### **4.2. Metallic**

* Значения должны быть **строго 0 или 1**.  
* Исключения: переходные слои (окисление, мокрая грязь на металле). Если площадь «серого» более 5% от меша — материал считается некорректным.

### **4.3. Roughness**

* Критическая ошибка: **0.0**. В реальном мире нет идеально гладких поверхностей (даже оптическое зеркало имеет Roughness \~0.01-0.02).  
* Для игровых движков рекомендуется минимальный порог **0.05** для предотвращения артефактов алиасинга на ярких бликах.

### **4.4. Specular (F0)**

* Для диэлектриков в UE это значение мапится как 0.5 \= 4% (0.04).  
* Почти все диэлектрики в мире имеют F0 в районе 2% \- 5%. Отклонение от 0.5 оправдано только для драгоценных камней или специфической химии.

## **5\. Заключение: Роль визуального анализа**

Модуль должен выполнять роль «автоматического тех-артиста», который в реальном времени подсвечивает пиксели, вышедшие за пределы физической точности. Это критично для проектов с динамическим освещением (Lumen), где любая ошибка в материале приводит к непредсказуемым «засветам» или провалам в черное.